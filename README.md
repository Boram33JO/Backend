<img src="https://github.com/Boram33JO/Backend/assets/131260371/962f6d63-bbe1-4c8a-b519-3fbe7c08b156"/>

# [P.Ple](https://pple.today)

<b>위치 기반 음악 공유 사이트</b>

#### 출근을 할 때, 친구들과 함께, 매번 어디론가 가고 머무는 ‘나’의 일상, 다들 음악과 함께 하고 계시지 않으신가요? 내가 추억하는 공간과 그 때의 플레이리스트를 모두와 함께 공유해보아요 🗣️🎧

<br />

## 💜 P.Ple 소개 - People Place Playlist

특별한 장소로 여행을 가거나, 일상 속에서 들었던 노래들을 플레이리스트로 만들어 다양한 사람들과 공유할 수 있는 커뮤니티 서비스입니다.

### 🔗 **[P.Ple (피플) 보러가기](https://pple.today)**

<br />

## 📆 프로젝트 기간

- 2023.07.29 ~ 2023.09.08

<br />

## 😎 Members

### Frontend

<table>
  <tr>
    <td align="center"><a href="https://github.com/Aurora-in-Wonderland"><img src="https://avatars.githubusercontent.com/u/99107568?v=4" width="100px" /></a></td>
    <td align="center"><a href="https://github.com/ownage2"><img src="https://avatars.githubusercontent.com/u/121753617?v=4" 
    width="100px" /></a></td>
    <td align="center"><a href="https://github.com/heexohee"><img src="https://user-images.githubusercontent.com/90495580/169259379-a913dd30-fa7f-4309-af30-9bd94c9608a6.png" width="100px" /></a></td>
  </tr>
   <tr>
    <td align="center"><b><a href="https://github.com/Aurora-in-Wonderland">김은비</a></b></td>
    <td align="center"><b><a href="https://github.com/ownage2">김정우</a></b></td>
    <td align="center"><b><a href="https://github.com/heexohee">정소희</a></b></td>
  </tr>
</table>

### Backend

<table>
  <tr>
    <td align="center"><a href="https://github.com/hyunJuS2"><img src="https://avatars.githubusercontent.com/u/134916809?v=4" width="100px" /></a></td>
    <td align="center"><a href="https://github.com/mabyoungg"><img src="https://github-production-user-asset-6210df.s3.amazonaws.com/131260371/266532257-1d32e8a1-d83f-41d8-afec-7f6eff111f5c.png" 
    width="100px" /></a></td>
    <td align="center"><a href="https://github.com/REWELLGOM"><img src="https://avatars.githubusercontent.com/u/129605750?v=4" width="100px" /></a></td>
  </tr>
   <tr>
    <td align="center"><b><a href="https://github.com/hyunJuS2">유현주</a></b></td>
    <td align="center"><b><a href="https://github.com/mabyoungg">최도영</a></b></td>
    <td align="center"><b><a href="https://github.com/REWELLGOM">이성목</a></b></td>
  </tr>
</table>

### Designer

<table>

  <tr>
    <td align="center"><a href=""><img src="https://user-images.githubusercontent.com/90495580/169259379-a913dd30-fa7f-4309-af30-9bd94c9608a6.png" width="100px" /></a>
  </tr>
   <tr>
    <td align="center"><b><a href="https://github.com/Aurora-in-Wonderland">오혜성</a></b></td>
  </tr>
</table>

<br/>
<br/>

## 💜 주요 기능 소개

<details>
<summary>📌 메인페이지</summary>

- 인기 포스팅, 추천 플레이리스트 등 P.Ple의 주 컨텐츠들을 확인할 수 있습니다.

<table>
  <tr>
    <td align="center"><img src="https://github.com/Boram33JO/Backend/assets/131260371/623ad72c-41d9-4d33-952c-1eb5b4f87e5a" width="100%" /></a></td>
    <td align="center"><img src="https://github.com/Boram33JO/Backend/assets/131260371/a340c25d-d218-419b-a73a-eb83ec3c8557" width="100%" /></a></td>
    <td align="center"><img src="https://github.com/Boram33JO/Backend/assets/131260371/0e563545-14cc-4280-8d7c-ad92a31cbd56" width="100%" /></a></td>   
  </tr>
</table>
</details>

<details>
<summary>📌 게시물 작성</summary>

- 장소 검색, 노래 검색을 이용해 해당 장소에 어울리는 플레이 리스트를 담아 게시물을 작성할 수 있습니다.

<table>
  <tr>
    <td align="center"><img src="https://github.com/Boram33JO/Backend/assets/131260371/ed0ba4d9-907a-464e-990d-c9415b3e1072" width="100%" /></a></td>
    <td align="center"><img src="https://github.com/Boram33JO/Backend/assets/131260371/ada3d21a-0438-4c93-8ec2-9f0b6ce35c24" width="100%" /></a></td>  
  </tr>
</table>
<table>
  <tr>
    <td align="center"><img src="https://github.com/Boram33JO/Backend/assets/131260371/6758d418-47fc-4dee-8b5a-b22a9f85fc62" width="100%" /></a></td>  
    <td align="center"><img src="https://github.com/Boram33JO/Backend/assets/131260371/0ffecbd7-3b71-475c-ab4f-3cf38a499672" width="100%" /></a></td>  
  </tr>
</table>
</details>

<details>
<summary>📌 장소에 따른 게시물 리스트</summary>

- GPS 기능을 통해 현재 내 위치 주변이나 특정 장소를 검색하여 그 주변의 작성된 게시물을 확인할 수 있습니다.

<table>
  <tr>
    <td align="center"><img src="https://github.com/Boram33JO/Backend/assets/131260371/0ffecbd7-3b71-475c-ab4f-3cf38a499672" width="100%" /></a></td>
    <td align="center"><img src="https://github.com/Boram33JO/Backend/assets/131260371/f9fa2d72-a150-43d7-aa16-5a8237c334f5" width="100%" /></a></td>
  </tr>
</table>

- GPS 기능을 통해 현재 내 위치 주변이나 특정 장소를 검색하여 그 주변의 작성된 게시물을 확인할 수 있습니다.

</details>

<details>
<summary>📌 프로필 페이지</summary>

- 내 프로필과 회원 정보를 수정할 수 있고, 내 포스팅, 팔로워, 댓글 등을 한 눈에 보고 관리할 수 있습니다.
- 다른 사람의 프로필의 경우 포스팅, 팔로워를 확인할 수 있습니다.

<table>
  <tr>
    <td align="center"><img src="https://github.com/Boram33JO/Backend/assets/131260371/1e1ce477-0fe7-473f-99bc-d7e82d58824c" width="100%" /></a></td>
    <td align="center"><img src="https://github.com/Boram33JO/Backend/assets/131260371/7fa457bb-22d9-4289-a9bc-7a18a38f6894" width="100%" /></a></td>
    <td align="center"><img src="https://github.com/Boram33JO/Backend/assets/131260371/9a76a10a-0477-47c8-b173-db21fdb6a30e" width="100%" /></a></td>  
  </tr>
</table>
<table>
  <tr>
    <td align="center"><img src="https://github.com/Boram33JO/Backend/assets/131260371/86783b7f-89be-4d9b-8645-582094028fa3" width="100%" /></a></td>
    <td align="center"><img src="https://github.com/Boram33JO/Backend/assets/131260371/61ee84e6-5692-4b34-84eb-af446098cea8" width="100%" /></a></td>
    <td align="center"><img src="https://github.com/Boram33JO/Backend/assets/131260371/edccdaa1-9eca-439e-b333-4debecea540c" width="100%" /></a></td>  
  </tr>
</table>
</details>

<details>
<summary>📌 게시물 상세</summary>

- 게시물의 상세 내용을 확인하고 댓글을 남겨 다른 사람과 의견을 공유할 수 있습니다.

<table>
  <tr>
    <td align="center"><img src="https://github.com/Boram33JO/Backend/assets/131260371/4b6f48b2-e650-4995-9df7-59fbf5683c5b" width="100%" /></a></td>
    <td align="center"><img src="https://github.com/Boram33JO/Backend/assets/131260371/36567da4-a958-431c-bf1f-434d70a7e86c" width="100%" /></a></td>
  </tr>
</table>

- 마음에 드는 게시물에 좋아요를 하거나 작성자를 팔로우 할 수 있습니다.

</details>
<details>
<summary>📌 미리 듣기 기능</summary>

- 음악을 선택하면 Spotify에서 제공하는 30초 미리 듣기를 들을 수 있습니다.

<table>
  <tr>
    <td align="center"><img src="https://github.com/Boram33JO/Backend/assets/131260371/9ba0e832-4daa-4dce-ba32-b35a18a6fa46" width="50%" /></a></td>
  </tr>
</table>

- 한 번 더 음악을 선택하면 Spotify 사이트로 이동합니다.

</details>
<details>
<summary>📌 알림 기능</summary>

- 로그인한 유저는 팔로우를 받거나 작성한 글에 다른 유저가 좋아요, 댓글 작성을 하면 알림을 받을 수 있습니다.

<table>
  <tr>
    <td align="center"><img src="https://github.com/Boram33JO/Backend/assets/131260371/ce2d3004-6e61-4600-bf38-c915a4a96187" width="100%" /></a></td>  
    <td align="center"><img src="https://github.com/Boram33JO/Backend/assets/131260371/f2ad7107-700c-420f-a7c2-071612126c2a" width="100%" /></a></td>  
  </tr>
</table>
</details>
<details>
<summary>📌 검색 기능</summary>

- 추천 포스팅, 인기 플레이스, 카테고리 별 인기 있는 노래, 인기 검색어를 확인할 수 있습니다.
- 검색어를 입력하여 관련된 포스팅, 플레이스, 음악, 피플러를 찾아볼 수 있습니다.

<table>
  <tr>
    <td align="center"><img src="https://github.com/Boram33JO/Backend/assets/131260371/f4aa6c4c-67c9-41f6-8169-5c1920edb6ad" width="100%" /></a></td>
    <td align="center"><img src="https://github.com/Boram33JO/Backend/assets/131260371/f10381c8-1127-4ced-b8f7-b6f0712224ec" width="100%" /></a></td>  
    <td align="center"><img src="https://github.com/Boram33JO/Backend/assets/131260371/47ba3504-0897-48a7-a627-372f54a46e12" width="100%" /></a></td>  
  </tr>
</table>
</details>

<br />

## ⚙️ 서비스 아키텍쳐

<img src="https://github.com/Boram33JO/Backend/assets/131260371/ca513b37-544c-422f-bac2-f4db2e26950b">

<br>

## 🔫 트러블슈팅

### Back-End

<details>
<summary> Issue1. RefreshToken으로 AccessToken 재발급시 RT 탈취 위험 이슈 </summary>

문제: </br>
* RefreshToken을 AccessToken과 함께 보내 만료 시 자동으로 AccessToken을 재발급 하게 하였지만, RefreshToken의 탈취 위험에 대한 문제점 발생

시도: </br>
* AT만료 시 RT로 AT룰 재발급하고 RT 또한 같이 재발급 방법을 시도
* 요청 시에는 AT만 요청 후 AT가 만료 시 만료 응답을 먼저 보내고 RT를 받아 새롭게 AT를 재발급 해주는 방식으로 변경 - RT만료시 로그아웃이 되는 방법을 시도

해결: </br>
* 로그인 시에 AT, RT를 함께 발급하고 요청 시에는 AT만 요청 후 AT가 만료 시 만료 응답을 먼저 보내고 RT를 받아 새롭게 AT를 재발급하게 하고 기존의 RT 만료 시 로그아웃이 되게 구현하는 방식만 채택

</details>

<details>
<summary> Issue2. Spotify API를 이용한 노래 검색 시 검색 제한 오류 발생 이슈 </summary>

문제: </br>
* 노래 검색 테스트 시 검색 제한으로 인해 많은 요청을 보낼 시  “API rate limit exceeded” 에러 메시지와 함께 API 응답의 대기 시간 발생.

시도: </br>
* 검색어에 대한 결과에 대해 캐싱 읽기 전략 Look Aside 패턴을 적용.
* 429 에러 응답 시 일정 시간이 지난 후 재시도.

해결: </br>
* 캐싱 읽기 전략 Look Aside 패턴을 적용하면서 한번에 더 많은 값을 받아올 수 있도록 10개에서 30개로 변경.

</details>

<details>
<summary> Issue3. 게시글 조회, 좋아요 동시성 제어 </summary>

문제: </br>
* 기존 게시글 조회 로직으로 JMeter 테스트 결과 1000개의 스레드 요청에 평균적으로 102개의 요청만 정상적으로 들어오고 898개의 요청은 유실

시도: </br>
* JPA 트랜잭션 내에서 읽기 → 쓰기 → 변경 감지의 순서로 흘러가는데 여러 트랜잭션이 동시에 읽기를 하고 쓰기 때문에 유실

해결: </br>
* 비관적락 베타락 설정으로 1000개의 요청 정상적으로 들어왔으나 성능은 저하
* 기존 로직은 1000개의 요청 8초, 변경 후 14초로 증가

</details>

<details>
<summary> Issue4. 게시글 조회수 어뷰징 </summary>

문제: </br>
* 기본 로직은 회원, 비회원 상관없이 브라우저를 새로고침하면 무한으로 조회수가 증가하는 문제 발생

시도: </br>
* 1차적으로 cookie를 사용하는 로직으로 변경하였으나,  도메인당 생성 할 수 있는 개수가 제한이 있고, cookie값이 커질 경우 네트워크 트래픽에 부담을 주고, 고의적으로 cookie를 삭제 할 수 있는 문제점이 존재

해결: </br>
* 2차적으로 비회원은 접속한 Client IP, 게시글 ID를 회원은 유저 ID, 게시글 ID를 Redis에 저장하고 만료 시간은 밤12시 기준으로 설정하는 로직으로 변경
* IP 또한 고의적으로 변경 할 수 있다는 문제점이 존재하나 어뷰징 유저가 조작하기에 cookie 방식보다 어렵다고 판단해 적용

</details>

### Infra

<details>
<summary> Issue1. AWS EC2 인스턴스 멈춤 현상 </summary>

문제: </br>
* 서버가 배포 되고 특정시간이 지나거나, spring boot 서버가 2개 이상 돌아가면 인스턴스가 멈추고 접속 안되는 현상 발생

시도: </br>
* 인스턴스 모니터링 결과 CPU 사용률이 급격하게 올라가고, 시스템 로그에서 Out of memory: kill process 발생해 메모리 부족으로 확인

해결: </br>
* 하드 디스크 공간 일부를 메모리로 대체하여 사용 할 수 있게 인스턴스에 Swap Memory 2GB 를 설정 하여 해결

</details>

<details>
<summary> Issue2. 이미지 업로드 에러 </summary>

문제: </br>
* 이미지 업로드시 5MB 크기 제한을 설정했지만 1MB 초과 해도 오류 발생
* application.properties 내에서는 정상적으로 설정, 실제 배포 서버에서만 오류 발생

시도: </br>
* 배포 서버에서는 Nginx로 reverse proxy 구성하면서 Nginx에서 기본으로 1MB 제한

해결: </br>
* nginx.conf 내에서 client_max_body_size 설정 후 해결

</details>

<details>
<summary> Issue3. Redis 쓰기 에러 </summary>

문제: </br>
* Redis는 persistent를 유지하기 위해서 주기적으로 BGSAVE로 RDB 파일을 저장, 이 과정에서 메모리가 부족하여 RDB 파일을 작성하다 실패하면 모든 쓰기 요청이 막혀 데이터 쓰기가 불가능

시도: </br>
* 프로젝트에서 Redis를 단순 캐시용도로 사용하고 있기 때문에 bgsave 에러가 났을 때 멈추는 설정 off

해결: </br>
* redis.conf 파일 내 SNAPSHOTTING 부분에 stop-writes-on-bgsave-error 부분이 기본 설정 yes에서 no로 변경

</details>

<details>
<summary> Issue4. 데이터 반환값 시간 문제 </summary>

문제: </br>
* EC2 인스턴스 서버 시간이 UTC 타임존으로 설정 돼있어 데이터 반환값들 시간이 9시간 차이 나는 문제 발생

시도: </br>
* RDS MySQL 타임존을 변경하였으나 여전히 문제 발생

해결: </br>
* sudo dpkg-reconfigure tzdata 명령어를 통해 서버 타임존을 KST로 변경

</details>

<details>
<summary> Issue5. Cloud Front 실시간 반영 안되는 문제 </summary>

문제: </br>
* S3에 업로드 된 수정 사항들이 배포에 실시간으로 반영 안되는 문제 발생
* 기본적으로 Cloud Front 캐시 정책은 각 파일을 24시간 후에 자동으로 만료

시도: </br>
* 공식 배포 전까지 캐시 정책 CachingDisabled 설정

해결: </br>
* 캐시 정책 시간 이전에 강제로 CloudFront의 배포 내용을 업데이트 하고 싶다면 무효화 생성해 적용 or 캐시 정책을 만들어 원하는 TTL 설정

</details>

<br />

## 🐰 기술

#### Frontend

<p>
  <img src="https://img.shields.io/badge/React-61DAFB?style=for-the-badge&logo=React&logoColor=black">
  <img src="https://img.shields.io/badge/typescript-blue?style=for-the-badge&logo=typescript&logoColor=white">
  <img src="https://img.shields.io/badge/axios-007CE2?style=for-the-badge&logo=axios&logoColor=white" >
  <img src="https://img.shields.io/badge/React_Router-CA4245?style=for-the-badge&logo=react-router&logoColor=white">
  <img src="https://img.shields.io/badge/redux-%23593d88.svg?style=for-the-badge&logo=redux&logoColor=white" >
  <img src="https://img.shields.io/badge/styled--components-DB7093?style=for-the-badge&logo=styled-components&logoColor=white" >
  <img src="https://img.shields.io/badge/React_Query-CA4245?style=for-the-badge&logo=reactquery-aws&logoColor=white" /> 
</p>

#### Backend

<p>
 <img src="https://img.shields.io/badge/Spring Boot-6DB33F?style=for-the-badge&logo=Spring Boot&logoColor=yellow">
 <img src="https://img.shields.io/badge/spring security-009639?style=for-the-badge&logo=springsecurity&logoColor=white">
 <img src="https://img.shields.io/badge/redis-CA4245?style=for-the-badge&logo=redis&logoColor=white">
 <img src="https://img.shields.io/badge/mysql-4479A1?style=for-the-badge&logo=mysql&logoColor=white">
 <img src="https://img.shields.io/badge/spring boot jpa-009639?style=for-the-badge&logo=spring boot jpa&logoColor=white">
 <img src="https://img.shields.io/badge/QueryDSL-31A8FF?style=for-the-badge&logoColor=white">
 <img src="https://img.shields.io/badge/json web token-ff00ff?style=for-the-badge&logo=jsonwebtokens&logoColor=white">
 <img src="https://img.shields.io/badge/swagger-85EA2?style=for-the-badge&logo=swagger&logoColor=white">
 <img src="https://img.shields.io/badge/junit5-25A162?style=for-the-badge&logo=junit5&logoColor=white">
</p>

#### Infrastructure

<p>
  <img src="https://img.shields.io/badge/nginx-009639?style=for-the-badge&logo=nginx&logoColor=white" >
  <img src="https://img.shields.io/badge/AWS-%23FF9900.svg?style=for-the-badge&logo=amazon-aws&logoColor=white" > 
  <img src="https://img.shields.io/badge/amazon s3-569A31?style=for-the-badge&logo=amazons3&logoColor=white" > 
  <img src="https://img.shields.io/badge/amazon rds-ff0000?style=for-the-badge&logo=amazonrds&logoColor=white">
  <img src="https://img.shields.io/badge/amazon ec2-FF9A00?style=for-the-badge&logo=amazonec2&logoColor=white" > 
  <img src="https://img.shields.io/badge/code deploy-569A31?style=for-the-badge&logoColor=white">
  <img src="https://img.shields.io/badge/Cloud Front-CA4245?style=for-the-badge&logoColor=white">
  <img src="https://img.shields.io/badge/github actions-2088FF?style=for-the-badge&logo=githubactions&logoColor=white">
</p>

#### Dev tools

<p> 
  <img src="https://img.shields.io/badge/Visual%20Studio%20Code-0078d7.svg?style=for-the-badge&logo=visual-studio-code&logoColor=white">
  <img src="https://img.shields.io/badge/intellij idea-6DB33F?style=for-the-badge&logo=intellijidea&logoColor=yellow">
  <img src="https://img.shields.io/badge/git-%23F05033.svg?style=for-the-badge&logo=git&logoColor=white">
  <img src="https://img.shields.io/badge/github-%23121011.svg?style=for-the-badge&logo=github&logoColor=white">
  <img src="https://img.shields.io/badge/apache jmeter-b81414?style=for-the-badge&logo=apachejmeter&logoColor=white">
</p>

#### Design

<p>
  <img src="https://img.shields.io/badge/Figma-F24E1E?style=for-the-badge&logo=Figma&logoColor=white"/>
  <img src="https://img.shields.io/badge/Adobe Illustrator-FF9A00?style=for-the-badge&logo=Adobe Illustrator&logoColor=white"/>
  <img src="https://img.shields.io/badge/Adobe Photoshop-31A8FF?style=for-the-badge&logo=Adobe Photoshop&logoColor=white"/>
</p>

</br>

## ☁️ ERD

![ERD](https://github.com/Boram33JO/Backend/assets/134916809/ddca8e23-1156-49a0-9a62-0e6627238812)
